def PowerShell(psCmd) {
  bat "powershell.exe -NonInteractive -ExecutionPolicy Bypass -Command \"\$ErrorActionPreference='Stop';$psCmd;EXIT \$global:LastExitCode\""
}

pipeline {
	node {
	  stage('git checkout') {
		  git 'file:///C:/Projects/SsdtDevOpsDemo'
	  }

	  stage('Build Dacpac from SQLProj') {
		  bat "\"${tool name: 'Default', type: 'msbuild'}\"  /p:Configuration=Release"
		  stash includes: 'SsdtDevOpsDemo\\bin\\Release\\SsdtDevOpsDemo.dacpac', name: 'theDacpac'
	  }

	  stage('Refresh test from production') {
		  PowerShell(". 'C:\\scripts\\Refresh-Test-Checkpoint-2016.ps1'")    
	  }

	  stage('Deploy Dacpac to SQL Server') {
		  unstash 'theDacpac'
		  bat "\"C:\\Program Files (x86)\\Microsoft SQL Server\\130\\DAC\\bin\\sqlpackage.exe\" /Action:Publish /SourceFile:\"SsdtDevOpsDemo\\bin\\Release\\SsdtDevOpsDemo.dacpac\" /TargetServerName:SQL2016\\DEVOPS_TST /TargetDatabaseName:SsdtDevOpsDemo"
	  }
	}
}
